Market State Engine v0.2

A daily signal engine computing four binary market state indicators (UP/DOWN) from sector ETFs using simple moving average (SMA) relative strength with config-driven architecture.

**Signals:**
- **Energy**: XLE relative strength vs SPY
- **Rates**: TLT as yield proxy (UP = yields rising / tightening)
- **Tech**: XLK relative strength vs SPY
- **Utilities**: XLU relative strength vs SPY

**Architecture:**
- Python (canonical compute) → daily NDJSON records
- Node validator → recomputes & diffs against canonical output with robust CSV parsing
- CI (GitHub Actions) → automated validation

Quickstart

1. Create and activate venv:

```powershell
python -m venv .venv
.\.venv\Scripts\Activate.ps1
```

2. Install dependencies:

```powershell
pip install -r requirements.txt
```

3. Run canonical compute on sample data (v0.2 config-driven):

```powershell
python -m src.python_mse.compute --input tests/sample/prices.csv --out data/canonical.ndjson
```

4. Run v0.1 legacy mode (for backward compatibility):

```powershell
python -m src.python_mse.compute --input tests/sample/prices.csv --out data/legacy.ndjson --legacy
```

5. Run Node validator:

```powershell
node src/node_validator/validator.js --prices tests/sample/prices.csv --canonical data/canonical.ndjson --window 20
```

Expected output:
```
VALIDATOR: OK — no mismatches found
```

6. Use custom config file:

```powershell
python -m src.python_mse.compute --input tests/sample/prices.csv --out data/custom.ndjson --config path/to/custom.yaml
```

Testing

**Python unit tests:**
```powershell
pytest tests/python/ -v
```

**Node unit tests:**
```powershell
node tests/node/test_validator.js
```

**CSV parsing features:**
- Handles quoted fields with commas: `"field with, comma"`
- Supports extra columns beyond required tickers
- Flexible quote handling and proper trimming
- Maintains backward compatibility with existing CSV files

CI/CD

GitHub Actions workflow (`.github/workflows/ci.yml`) runs:
1. Python canonical compute + unit tests
2. Node validator + unit tests
3. Diff validation (exit code 0 = pass, 1 = fail)

File Structure

```
├── PRD.md                          # Original specification
├── README.md                       # This file
├── signals.yaml                    # v0.2 signal configuration
├── walkthrough.md                  # Detailed implementation guide
├── requirements.txt                # Python dependencies
├── src/
│   ├── python_mse/                 # Canonical compute module
│   │   ├── __init__.py
│   │   ├── __main__.py
│   │   └── compute.py              # Core signal logic
│   └── node_validator/             # Node validator
│       ├── package.json
│       ├── package-lock.json
│       └── validator.js
├── data/                           # Outputs
│   ├── canonical.ndjson            # Generated by Python
```

v0.2 Features

- **Config-driven signals** via `signals.yaml`
- **Per-signal metrics** (value + SMA) in output
- **Backward compatibility** with v0.1 via `--legacy` flag
- **Flexible signal kinds**: `relative_strength` and `price_proxy`
- **Rule-based logic**: `gt_sma` and `lt_sma` rules
- Binary signals only (UP / DOWN / NA)
- Daily frequency
- Sector ETF proxies (XLE, TLT, XLK, XLU)
- Robust CSV parsing with quoted fields and extra columns support

v0.1 Legacy (Backward Compatible)

- 20-day SMA window (fixed)
- Hardcoded signal definitions
- No per-signal metrics in output
- Same signal semantics as v0.2

Data requirements and enforcement

- The input `prices.csv` must represent adjusted close prices. Preferred column naming is `<TICKER>_adj_close` (for example `XLE_adj_close`).
- Backwards-compatibility: plain ticker columns like `XLE` are accepted but a runtime WARNING is emitted. For strict enforcement, provide files with `<TICKER>_adj_close` columns.
- **Enhanced CSV parsing**: Node validator uses csv-parse library supporting quoted fields and extra columns for robust data ingestion.

SMA NA policy

- If the SMA window is not yet filled (i.e. fewer than `window` observations), the signal value MUST be `NA` for that date. Both Python and Node validator follow this rule to guarantee consistent diffs.

Output Schema

v0.2 includes enhanced metrics:
```json
{
  "date": "2025-12-20",
  "signals": {
    "energy": "UP",
    "rates": "DOWN", 
    "tech": "UP",
    "utilities": "NA"
  },
  "metrics": {
    "energy": {"value": 0.195, "sma": 0.190},
    "rates": {"value": 108.5, "sma": 109.2},
    "tech": {"value": 0.385, "sma": 0.380},
    "utilities": {"value": 0.165, "sma": null}
  },
  "inputs": {
    "price_field": "adj_close",
    "window": 20,
    "tickers": ["SPY", "TLT", "XLE", "XLK", "XLU"]
  },
  "version": "0.2"
}
```

Future Enhancements

- Configurable windows (20/50/200)
- Multi-level strength scores
- Alternative yield curves for Rates
- Volatility and credit signals

